<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美股ETF监控：QQQ SMH TSLA GLD IBIT 等跌破120/240日均线警报 + 每日自动刷新 & 声音通知</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        h1 { text-align: center; }
        .ticker { margin: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .alert { color: red; font-weight: bold; font-size: 1.2em; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>美股ETF实时监控（QQQ、SMH、TSLA、GLD、IBIT、SPY 等）</h1>
    <button onclick="checkAll()">手动立即检查</button>
    <div id="results"></div>

    <audio id="alertSound" src="https://cdn.freesound.org/previews/612/612810_5674468-lq.mp3" preload="auto"></audio>
    <!-- 免费警报声音（叮铃声），可替换为其他URL -->

    <script>
        const tickers = ['SPY', 'QQQ', 'SMH', 'TSLA', 'GLD', 'IBIT'];

        async function getData(ticker) {
            const url = `https://query2.finance.yahoo.com/v8/finance/chart/${ticker}?range=max&interval=1d&includeAdjustedClose=true`;
            const response = await fetch(url, { headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' } });
            if (!response.ok) throw new Error('请求失败，刷新重试');
            const data = await response.json();
            const result = data.chart.result[0];
            if (!result) throw new Error('无数据');

            const currentPrice = result.meta.regularMarketPrice;
            const closes = result.indicators.quote[0].close.filter(v => v !== null).reverse();

            return { currentPrice, closes };
        }

        function calculateMA(prices, period) {
            if (prices.length < period) return null;
            return prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
        }

        async function checkTicker(ticker) {
            try {
                const { currentPrice, closes } = await getData(ticker);

                const ma120 = calculateMA(closes, 120);
                const ma240 = calculateMA(closes, 240);

                let html = `<div class="ticker"><h2>${ticker}</h2>`;
                html += `<p>当前价格: <strong>${currentPrice.toFixed(2)}</strong></p>`;
                html += `<p>120日均线: ${ma120 ? ma120.toFixed(2) : '历史不足，无法计算'}</p>`;
                html += `<p>240日均线: ${ma240 ? ma240.toFixed(2) : '历史不足，无法计算'}</p>`;

                let alerts = [];
                if (ma120 && currentPrice < ma120) alerts.push('⚠️ 已跌破120日均线！定投加仓信号？');
                if (ma240 && currentPrice < ma240) alerts.push('⚠️ 已跌破240日均线！大级别机会警报！');

                if (alerts.length > 0) {
                    html += `<p class="alert">${alerts.join('<br>')}</p>`;
                    // 播放声音通知
                    document.getElementById('alertSound').play().catch(e => console.log('声音播放失败:', e));
                } else {
                    html += `<p>当前价格高于均线，暂无加仓信号。</p>`;
                }
                html += `</div>`;
                return html;
            } catch (e) {
                return `<div class="ticker"><h2>${ticker}</h2><p style="color:red;">错误: ${e.message}（Yahoo临时问题或网络，刷新重试）</p></div>`;
            }
        }

        async function checkAll() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>正在加载数据...（首次10-30秒）</p>';

            let html = '';
            let hasAlert = false;
            for (const ticker of tickers) {
                const tickerHtml = await checkTicker(ticker);
                html += tickerHtml;
                if (tickerHtml.includes('class="alert"')) hasAlert = true;
                await new Promise(r => setTimeout(r, 1500));
            }

            // 如果有任何警报，额外播放声音（确保触发）
            if (hasAlert) {
                document.getElementById('alertSound').play().catch(e => console.log('声音播放失败:', e));
            }

            resultsDiv.innerHTML = html + '<p>数据更新时间：' + new Date().toLocaleString() + '（来源：Yahoo Finance）</p>';
        }

        // 每日自动刷新：每24小时（86400000毫秒）检查一次
        // 另外，每小时检查一次（更及时捕捉跌破）
        setInterval(checkAll, 86400000);  // 每1小时自动刷新（可改为86400000为每天一次）

        // 页面加载时立即检查
        window.onload = checkAll;
    </script>

    <h2>新功能说明</h2>
    <ul>
        <li><strong>自动每日刷新</strong>：代码设置为每1小时自动检查一次（捕捉更及时），如需严格每天一次，改setInterval数字为86400000。</li>
        <li><strong>手机/电脑声音通知</strong>：有跌破120/240日均线时，自动播放警报声音（叮铃声，手机浏览器也支持）。</li>
        <li>数据来源Yahoo，实测2025.12.23正常加载（加User-Agent绕过限制，若偶尔错误刷新页面）。</li>
        <li>手机浏览器（Chrome）打开，保持页面后台运行，即可实现“每日”提醒。</li>
        <li>当前市场强势，无警报；大跌时声音会响，抓住加仓机会！</li>
    </ul>
</body>
</html>
